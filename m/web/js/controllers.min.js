angular.module("starter.controllers",[]).run(["$rootScope","$state","$ionicViewSwitcher","$ionicPopup","Params","Helper","UserService","AccountService","CartService","OrderService","AddressService",function(t,e,a,i,o,n,r,s,c,d,l){t.Params=o,t.Helper=n,t.$on("$stateChangeStart",function(t,i,o,s,c){"@"===i.access&&r.isGuest?(t.preventDefault(),a.nextDirection("forward"),e.go("login")):"?"!==i.access||r.isGuest||(t.preventDefault(),a.nextDirection("back"),n.back())}),t.$on("$stateChangeSuccess",function(e,a,i,o,n){t.previousState=o,t.previousParams=n}),t.$on("userLoginSuccess",function(t){s.reload(),d.reload(),l.reload()}),t.$on("userLogoutSuccess",function(t){s.destroy(),d.destroy(),l.destroy(),c.destroyAll()}),t.$on("responseError",function(t,o){401==o.status?r.isGuest||(r.logout(),a.nextDirection("forward"),e.go("login"),i.alert({title:"登录过期",template:"登录过期，请您重新登录！"})):i.alert({title:"请求出错",template:o.data.message||o.message})})}]).controller("HomeCtrl",["$scope","$state","SchoolService",function(t,e,a){null!==a.lastSchoolId&&e.go("tab.school",{id:a.lastSchoolId}),t.SchoolService=a}]).controller("SchoolCtrl",["$scope","$stateParams","$http","SchoolService",function(t,e,a,i){a.get("api/v1/school/detail",{params:{id:e.id}}).then(function(e){t.title=e.data.name,t.stores=e.data.stores}),i.setLastSchoolId(e.id)}]).controller("SchoolSwitchCtrl",["$scope","SchoolService",function(t,e){t.SchoolService=e}]).controller("StoreCtrl",["$scope","$state","$stateParams","$http","$ionicModal","$ionicPopup","$ionicViewSwitcher","$ionicScrollDelegate","UserService","CartService",function(t,e,a,i,o,n,r,s,c,d){t.UserService=c,t.cart=d.get(a.id),i.get("api/v1/store/detail",{params:{id:a.id}}).then(function(e){t.title=e.data.store.name,t.store=e.data.store,t.categories=e.data.categories,t.goodsList=e.data.goodsList,t.category="c"+Object.keys(t.categories)[0];var i=[];ionic.DomUtil.ready(function(){for(var t=document.getElementById("content-"+a.id).getElementsByClassName("cateblock"),e=t.length-1;e>=0;e--)i[t[e].id]=t[e].offsetTop}),t.goodsScrollComplete=function(){var e=s.$getByHandle("goodsScroll").getScrollPosition().top;for(var a in i)if(e>=i[a]){t.$apply(function(){t.category=a});break}},t.scrollTo=function(t){var e=i[t];s.scrollTo(0,e,!0)}}),o.fromTemplateUrl("modal-goods.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.modalGoods=e}),o.fromTemplateUrl("modal-cart.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.modalCart=e}),t.openGoods=function(e){e.images||(e.images=[],i.get("api/v1/goods/images",{params:{id:e.id}}).then(function(t){e.images=t.data})),t.modalGoods.goods=e,t.modalGoods.show()},t.$on("$ionicView.enter",function(){c.isGuest||d.refresh(a.id)}),t.getCartGoodsCount=function(e){if(!c.isGuest){var a=t.cart.goodsList[e];if(a)return a.count}return 0};var l=function(){n.confirm({title:"请登录后操作，您现在要登录吗？",cancelText:"取消",okText:"确定"}).then(function(t){t&&(r.nextDirection("forward"),e.go("login"))})};t.add=function(t){return c.isGuest?void l():void d.add(a.id,t)["catch"](function(t){"fail"===t.data.status&&t.data.data.message&&n.alert({title:"提示",template:t.data.data.message})})},t.subtract=function(t){return c.isGuest?void l():void d.subtract(a.id,t)["catch"](function(t){"fail"===t.data.status&&t.data.data.message&&n.alert({title:"提示",template:t.data.data.message})})},t.clear=function(){d.clear(a.id)},t["delete"]=function(t){d["delete"](a.id,t)}}]).controller("OrderCtrl",["$scope","$http","$ionicPopup","$ionicLoading","OrderService","UserService",function(t,e,a,i,o,n){t.OrderService=o,t.UserService=n,t.refresh=function(){o.reload()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.moreDataCanBeLoaded=function(){return!o.isEnd},t.loadMore=function(){o.loadNext()["finally"](function(){t.$broadcast("scroll.infiniteScrollComplete")})},t.removeable=function(t){return"completed"===t.status||"cancelled"===t.status},t.remove=function(t){i.show(),e["delete"]("api/v1/order/delete",{params:{id:t.id}}).then(function(t){"success"===t.data.status?o.reload():"fail"===t.data.status&&a.alert({title:"删除失败",template:"请刷新后重试！"}),i.hide()})}}]).controller("OrderDetailCtrl",["$scope","$stateParams","$http","$ionicPopup","$ionicLoading","OrderService",function(t,e,a,i,o,n){a.get("api/v1/order/detail",{params:{id:e.id}}).then(function(e){t.order=e.data}),t.refresh=function(){a.get("api/v1/order/detail",{params:{id:e.id}}).then(function(e){t.order=e.data})["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.receive=function(){i.confirm({title:"确认收货",template:"如果您已收到订单，请确认收货。",cancelText:"取消",okText:"确认"}).then(function(a){a&&(o.show(),n.receive(e.id).then(function(e){t.order.status=e.data.data.status,t.order.statusMsg=e.data.data.statusMsg})["finally"](function(){o.hide()}))})},t.cancel=function(){i.confirm({title:"取消订单",template:"您确定要取消该订单吗？",cancelText:"关闭",okText:"取消",okType:"button-assertive"}).then(function(a){a&&(o.show(),n.cancel(e.id).then(function(e){t.order.status=e.data.data.status,t.order.statusMsg=e.data.data.statusMsg})["finally"](function(){o.hide()}))})},t.orderTimeout=function(){o.show(),n.timeout(e.id).then(function(e){t.order.status=e.data.data.status,t.order.statusMsg=e.data.data.statusMsg})["finally"](function(){o.hide()})}}]).controller("OrderCreateCtrl",["$scope","$state","$stateParams","$http","$ionicViewSwitcher","$ionicLoading","Params","Helper","AccountService","OrderService","AddressService","MemoryStorage",function(t,e,a,i,o,n,r,s,c,d,l,u){t.AccountService=c,t.AddressService=l,t.newDownItems={1:r.newDownMsg,0:"不使用优惠"},u.has("createOrderFormData")||u.set("createOrderFormData",{}),t.data=u.get("createOrderFormData"),t.data.payment="online",t.data.remark="",i.get("api/v1/order/create",{params:{id:a.id}}).then(function(e){t.realFee=t.fee=e.data.fee,t.store=e.data.store,t.cartGoodsList=e.data.cartGoodsList,t.preferentialItems=e.data.preferentialItems,t.bookTimeItems=e.data.bookTimeItems,e.data.addressList.length>0&&(t.data.addressId=e.data.addressList[0].id),s.isEmptyObject(t.preferentialItems)||(t.data.preferential=Object.keys(t.preferentialItems)[0]),s.isEmptyObject(t.bookTimeItems)||(t.data.bookTime=Object.keys(t.bookTimeItems)[0]),ionic.DomUtil.ready(function(){t.updateRealFee()})}),t.updateRealFee=function(){var e=s.number(t.fee),a=e;switch(t.data.preferential){case"down":t.store.has_down&&e>=t.store.down_upper&&(a-=t.store.down_val)}r.enableNewDown&&"1"===t.data.newDown&&e>=r.newDownUpper&&c.hasNewDown&&(a-=r.newDownVal,0>a&&(a=0)),t.realFee=a.toFixed(2)},t.submit=function(r){n.show(),t.errors=[],t.successMsg=null,i.post("api/v1/order/create",r,{params:{id:a.id}}).then(function(a){"success"===a.data.status?(t.successMsg="订单创建成功！",u.remove("createOrderFormData"),d.reload(),"1"===r.newDown&&(c.hasNewDown=!1),o.nextDirection("forward"),"online"===a.data.data.payment?e.go("order-pay",{id:a.data.data.id}):e.go("order-detail",{id:a.data.data.id})):t.errors=a.data.data.errors})["finally"](function(){n.hide()})}}]).controller("OrderCreateAddressCtrl",["$scope","$state","$stateParams","$http","$ionicViewSwitcher","$ionicPopup","$ionicLoading","Helper","AddressService","MemoryStorage",function(t,e,a,i,o,n,r,s,c,d){t.schoolId=a.id,t.AddressService=c,d.has("createOrderFormData")||d.set("createOrderFormData",{}),t.data=d.get("createOrderFormData"),t.refresh=function(){c.reload()["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.select=function(e){t.data.addressId=e.id,o.nextDirection("back"),s.back()},t.edit=function(t){o.nextDirection("forward"),e.go("order-create-address-edit",{id:t.id})},t.remove=function(t){r.show(),i["delete"]("api/v1/address/delete",{params:{id:t.id}}).then(function(e){"success"===e.data.status?c.all.splice(c.all.indexOf(t),1):"fail"===e.data.status&&n.alert({title:"删除失败",template:e.data.data.message})})["finally"](function(){r.hide()})}}]).controller("OrderCreateAddressAddCtrl",["$scope","$stateParams","$http","$ionicViewSwitcher","$ionicLoading","Helper","SchoolService","AddressService",function(t,e,a,i,o,n,r,s){t.title="新增收货地址",t.data={school_id:e.schoolId},t.SchoolService=r,t.AddressService=s,a.get("api/v1/school/buildings",{params:{id:e.schoolId}}).then(function(e){t.buildings=e.data,t.data.building_id=Object.keys(t.buildings)[0]||""}),t.submit=function(e){o.show(),a.post("api/v1/address/create",e).then(function(e){"success"===e.data.status?(s.reload(),n.back()):"fail"===e.data.status&&(t.errors=e.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("OrderCreateAddressEditCtrl",["$scope","$stateParams","$http","$ionicLoading","Helper","SchoolService","AddressService",function(t,e,a,i,o,n,r){t.title="编辑收货地址",t.SchoolService=n,t.AddressService=r,a.get("api/v1/address/detail",{params:{id:e.id}}).then(function(e){t.data=e.data,a.get("api/v1/school/buildings",{params:{id:t.data.school_id}}).then(function(e){t.buildings=e.data})}),t.submit=function(n){i.show(),a.put("api/v1/address/update",n,{params:{id:e.id}}).then(function(e){"success"===e.data.status?(r.reload(),o.back()):"fail"===e.data.status&&(t.errors=e.data.data.errors)})["finally"](function(){i.hide()})}}]).controller("OrderCreateRemarkCtrl",["$scope","$ionicViewSwitcher","Helper","MemoryStorage",function(t,e,a,i){t.data={},i.has("createOrderFormData")&&i.get("createOrderFormData").remark&&(t.data.remark=i.get("createOrderFormData").remark),t.save=function(t){i.has("createOrderFormData")||i.set("createOrderFormData",{}),i.get("createOrderFormData").remark=t.remark,e.nextDirection("back"),a.back()}}]).controller("OrderPayCtrl",["$scope","$state","$stateParams","$http","$ionicViewSwitcher","$ionicPopup","$ionicLoading","OrderService",function(t,e,a,i,o,n,r,s){t.canUseWxpay=void 0!=window.WeixinJSBridge,i.get("api/v1/order/detail",{params:{id:a.id}}).then(function(e){t.order=e.data}),t.orderTimeout=function(){r.show(),s.timeout(a.id).then(function(e){t.order.status=e.data.data.status,t.order.statusMsg=e.data.data.statusMsg})["finally"](function(){r.hide()})},t.pay=function(t){r.show(),i.post("api/v1/order/pay",{channel:t},{params:{id:a.id}}).then(function(t){"success"===t.data.status?pingpp.createPayment(t.data.data.charge,function(t,i){"success"==t?(n.alert({title:"恭喜支付成功！"}),o.nextDirection("back"),e.go("order-detail",{id:a.id})):"fail"==t&&n.alert({title:"支付失败！",template:i.msg})}):n.alert({title:"请求失败！",template:t.data.data.message})})["finally"](function(){r.hide()})}}]).controller("ICtrl",["$scope","UserService","AccountService",function(t,e,a){t.UserService=e,t.AccountService=a}]).controller("IAccountCtrl",["$scope","$state","$ionicPopup","$ionicViewSwitcher","UserService","AccountService",function(t,e,a,i,o,n){t.UserService=o,t.AccountService=n,t.logout=function(){a.confirm({title:"退出当前帐号？",cancelText:"取消",okText:"确定"}).then(function(a){a&&(o.logout(),t.$emit("userLogoutSuccess"),i.nextDirection("back"),e.go("tab.i"))})}}]).controller("IAccountNicknameCtrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading","AccountService",function(t,e,a,i,o,n){t.data={nickname:n.nickname},t.submit=function(r){o.show(),a.put("api/v1/i/nickname",r).then(function(a){"success"===a.data.status?(n.nickname=r.nickname,i.nextDirection("back"),e.go("i-account")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAccountGenderCtrl",["$scope","$state","$http","$ionicViewSwitcher","AccountService",function(t,e,a,i,o){t.AccountService=o,t.data={gender:o.gender},t.submit=function(n){a.put("api/v1/i/gender",n).then(function(a){"success"===a.data.status?(o.gender=n.gender,i.nextDirection("back"),e.go("i-account")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})}}]).controller("IAccountMobileVerifyCtrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading","AccountService",function(t,e,a,i,o,n){t.AccountService=n,t.submit=function(n){o.show(),a.post("api/v1/i/verify-password",n).then(function(a){"success"===a.data.status?(window.sessionStorage.setItem("isVerifed","Y"),i.nextDirection("forward"),e.go("i-account-mobile")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAccountMobileCtrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading","AccountService",function(t,e,a,i,o,n){"Y"!==window.sessionStorage.getItem("isVerifed")&&(i.nextDirection("back"),e.go("i-account-mobile")),t.submit=function(n){o.show(),a.post("api/v1/i/mobile",n).then(function(a){"success"===a.data.status?(window.sessionStorage.setItem("isMsgSent","Y"),i.nextDirection("forward"),e.go("i-account-mobile-step2")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAccountMobileStep2Ctrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading","AccountService",function(t,e,a,i,o,n){"Y"!==window.sessionStorage.getItem("isMsgSent")&&(i.nextDirection("back"),e.go("i-account-mobile")),t.submit=function(r){o.show(),a.put("api/v1/i/mobile",r,{params:{step:2}}).then(function(a){"success"===a.data.status?(n.mobile=a.data.data.mobile,i.nextDirection("back"),e.go("i-account")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAccountEmailCtrl",["$scope","$state","$http","$ionicPopup","$ionicViewSwitcher","$ionicLoading","$ionicLoading","AccountService",function(t,e,a,i,o,n,n,r){t.AccountService=r,t.remove=function(){i.confirm({title:"解除当前绑定？",cancelText:"取消",okText:"确定"}).then(function(t){t&&(n.show(),a["delete"]("api/v1/i/remove-email").then(function(t){"success"===t.data.status&&(r.email=null,o.nextDirection("back"),e.go("i-account"))})["finally"](function(){n.hide()}))})},t.submit=function(i){n.show(),a.put("api/v1/i/email",i).then(function(a){"success"===a.data.status?(window.sessionStorage.setItem("isEmailSent","Y"),o.nextDirection("forward"),e.go("i-account-email-step2")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){n.hide()})}}]).controller("IAccountEmailStep2Ctrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading","AccountService",function(t,e,a,i,o,n){"Y"!==window.sessionStorage.getItem("isEmailSent")&&(i.nextDirection("back"),e.go("i-account-email")),t.submit=function(r){o.show(),a.put("api/v1/i/email",r,{params:{step:2}}).then(function(a){"success"===a.data.status?(n.email=a.data.data.email,i.nextDirection("back"),e.go("i-account")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAccountPasswordCtrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading",function(t,e,a,i,o){t.submit=function(n){o.show(),a.post("api/v1/i/verify-password",n).then(function(a){"success"===a.data.status?(window.sessionStorage.setItem("isVerifed","Y"),i.nextDirection("forward"),e.go("i-account-password-step2")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAccountPasswordStep2Ctrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading",function(t,e,a,i,o){"Y"!==window.sessionStorage.getItem("isVerifed")&&(i.nextDirection("back"),e.go("i-account-password")),t.submit=function(n){o.show(),a.put("api/v1/i/password",n).then(function(a){"success"===a.data.status?(window.sessionStorage.removeItem("isVerifed"),i.nextDirection("back"),e.go("i-account")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("IAddressCtrl",["$scope","$http","$ionicPopup","$ionicLoading","AddressService",function(t,e,a,i,o){t.AddressService=o,t.refresh=function(){o.reload().then(function(e){t.$broadcast("scroll.refreshComplete")})},t.remove=function(t){i.show(),e["delete"]("api/v1/address/delete",{params:{id:t.id}}).then(function(e){"success"===e.data.status?o.all.splice(o.all.indexOf(t),1):"fail"===e.data.status&&a.alert({title:"删除失败",template:e.data.data.message})})["finally"](function(){i.hide()})}}]).controller("IAddressCreateCtrl",["$scope","$http","$ionicLoading","Helper","SchoolService","AddressService",function(t,e,a,i,o,n){t.title="新增收货地址",t.SchoolService=o,t.AddressService=n,t.data={consignee:"",gender:Object.keys(n.genderList)[0],cellphone:"",school_id:"",building_id:"",room:""};var r=[];t.changeSchool=function(a){return r[a]?(t.buildings=r[a],void(t.data.building_id=Object.keys(t.buildings)[0]||"")):void e.get("api/v1/school/buildings",{params:{id:a}}).then(function(e){r[a]=e.data,t.buildings=r[a],t.data.building_id=Object.keys(t.buildings)[0]||""})},t.submit=function(o){a.show(),e.post("api/v1/address/create",o).then(function(e){"success"===e.data.status?(n.reload(),i.back()):"fail"===e.data.status&&(t.errors=e.data.data.errors)})["finally"](function(){a.hide()})}}]).controller("IAddressUpdateCtrl",["$scope","$stateParams","$http","$ionicLoading","Helper","SchoolService","AddressService",function(t,e,a,i,o,n,r){t.title="更新收货地址",t.SchoolService=n,t.AddressService=r;var s=[];t.changeSchool=function(e){return s[e]?(t.buildings=s[e],void(t.data.building_id=Object.keys(t.buildings)[0]||"")):void a.get("api/v1/school/buildings",{params:{id:e}}).then(function(a){s[e]=a.data,t.buildings=s[e],t.data.building_id=Object.keys(t.buildings)[0]||""})},a.get("api/v1/address/detail",{params:{id:e.id}}).then(function(e){t.data=e.data,a.get("api/v1/school/buildings",{params:{id:t.data.school_id}}).then(function(e){s[t.data.school_id]=e.data,t.buildings=s[t.data.school_id]})}),t.submit=function(n){i.show(),a.put("api/v1/address/update",n,{params:{id:e.id}}).then(function(e){"success"===e.data.status?(r.reload(),o.back()):"fail"===e.data.status&&(t.errors=e.data.data.errors)})["finally"](function(){i.hide()})}}]).controller("HelpCtrl",["$scope",function(t){}]).controller("HelpItemCtrl",["$scope","$stateParams",function(t,e){t.id=e.id}]).controller("MoreCtrl",["$scope",function(t){}]).controller("JoinusCtrl",["$scope",function(t){}]).controller("FeedbackCtrl",["$scope","$state","$http","$ionicPopup","$ionicLoading","$ionicViewSwitcher",function(t,e,a,i,o,n){t.submit=function(r){o.show(),a.post("api/v1/default/feedback",r).then(function(a){"success"===a.data.status?(i.alert({title:"感谢您的反馈",template:"感谢您的反馈，我们将努力为您做更好的产品。"}),n.nextDirection("back"),e.go("more")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("SignupCtrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading",function(t,e,a,i,o){t.updateCaptcha=function(){a.get("api/v1/default/captcha",{params:{refresh:1}}).then(function(e){t.captchaUrl=e.data.url})},t.updateCaptcha(),t.submit=function(n){o.show(),a.post("api/v1/default/signup",n).then(function(a){"success"===a.data.status?(window.sessionStorage.setItem("signupMsgSent","Y"),i.nextDirection("forward"),e.go("signup-step2")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]).controller("SignupStep2Ctrl",["$scope","$state","$http","$ionicPopup","$ionicViewSwitcher","$ionicLoading","UserService",function(t,e,a,i,o,n,r){"Y"!==window.sessionStorage.getItem("signupMsgSent")&&(o.nextDirection("back"),e.go("signup")),t.sendMsg=function(){i.confirm({title:"重新发送验证码？",cancelText:"取消",okText:"确定"}).then(function(e){e&&a.post("api/v1/default/send-msg").then(function(e){"success"===e.data.status?window.sessionStorage.removeItem("signupMsgSent"):"fail"===e.data.status&&(t.errors=e.data.data.errors)})})},t.submit=function(i){n.show(),a.post("api/v1/default/signup",i,{params:{step:2}}).then(function(a){"success"===a.data.status?(r.login(a.data.data.accessToken),t.$emit("userLoginSuccess"),o.nextDirection("forward"),e.go("i-account")):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){n.hide()})}}]).controller("LoginCtrl",["$scope","$state","$http","$ionicViewSwitcher","$ionicLoading","UserService",function(t,e,a,i,o,n){t.login=function(r){o.show(),a.post("api/v1/default/login",r).then(function(a){"success"===a.data.status?(n.login(a.data.data.token),t.$emit("userLoginSuccess"),t.previousState?(i.nextDirection("back"),e.go(t.previousState.name,t.previousParams,{reload:!0})):(i.nextDirection("forward"),e.go("i-account"))):"fail"===a.data.status&&(t.errors=a.data.data.errors)})["finally"](function(){o.hide()})}}]);