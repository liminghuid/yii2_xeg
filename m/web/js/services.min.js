angular.module("starter.services",[]).directive("mobile",function(){return{require:"ngModel",link:function(t,e,n,i){i.$validators.mobile=function(t,e){return/^1[3|4|5|7|8][0-9]{9}$/.test(e)?!0:!1}}}}).directive("password",function(){return{require:"ngModel",link:function(t,e,n,i){i.$validators.password=function(t,e){return/^\S{6,32}$/.test(e)?!0:!1}}}}).directive("countdown",["$interval",function(t){var e=function(t,e){var n,i,a,r,o;return n=Math.floor(t/86400),t-=86400*n,i=Math.floor(t/3600)%24,t-=3600*i,a=Math.floor(t/60)%60,t-=60*a,r=t%60,o=e.replace("dd",("0"+n).slice(-2)),o=o.replace("d",n),o=o.replace("hh",("0"+i).slice(-2)),o=o.replace("h",i),o=o.replace("mm",("0"+a).slice(-2)),o=o.replace("m",a),o=o.replace("ss",("0"+r).slice(-2)),o=o.replace("s",r)};return{restrict:"E",link:function(n,i,a){var r=new Date(Number(a.time)),o=function(){var o=Math.floor((r.getTime()-(new Date).getTime())/1e3);0>o?(t.cancel(s),a.onFinish&&n.$eval(a.onFinish)):i.text(e(o,a.format))},s=t(o,1e3);o(),i.on("$destroy",function(){t.cancel(s)})}}}]).constant("$ionicLoadingConfig",{template:"Loading..."}).constant("Helper",{back:function(){window.history.back()},isEmptyObject:function(t){for(var e in t)return!1;return!0},number:function(t){return Number(t)},generateRandomString:function(t){return Math.round(Math.pow(36,t+1)-Math.random()*Math.pow(36,t)).toString(36).slice(1)}}).constant("MemoryStorage",{_data:{},get:function(t){return this._data[t]},set:function(t,e){this._data[t]=e},has:function(t){return void 0!=this._data[t]},remove:function(t){delete this._data[t]},getAll:function(){return this._data},destroy:function(){this._data={}}}).factory("httpInterceptor",["$rootScope","$q",function(t,e){return{request:function(t){return t.withCredentials=!0,t},requestError:function(t){return e.reject(t)},response:function(t){return t},responseError:function(n){return t.$emit("responseError",n),e.reject(n)}}}]).factory("UserService",["$http",function(t){var e={isGuest:!0,login:function(t){this.isGuest=!1,this.setCredentials(t)},logout:function(){this.isGuest=!0,this.destroyCredentials()},setCredentials:function(e){t.defaults.headers.common["X-Auth-Token"]=e,window.localStorage.setItem("accessToken",e)},destroyCredentials:function(){delete t.defaults.headers.common["X-Auth-Token"],window.localStorage.removeItem("accessToken")},init:function(){var t=window.localStorage.getItem("accessToken");t&&(this.isGuest=!1,this.setCredentials(t))}};return e.init(),e}]).factory("AccountService",["$http","$q","UserService",function(t,e,n){var i={mobile:null,nickname:null,gender:null,email:null,hasNewDown:!1,genderList:{male:"男",woman:"女",other:"保密"},getSymbolMobile:function(){if(null===this.mobile)return null;var t=this.mobile+"";return t.slice(0,3)+"****"+t.slice(7,11)},getGenderMsg:function(){return null===this.gender?null:this.genderList[this.gender]},reload:function(){return e(function(e,a){t.get("api/v1/i/profile").then(function(t){"success"===t.data.status?(i.mobile=t.data.data.mobile,i.nickname=t.data.data.nickname,i.gender=t.data.data.gender,i.email=t.data.data.email,i.hasNewDown=t.data.data.hasNewDown,e(t)):(n.logout(),a(t))},function(t){a(t)})})},destroy:function(){this.mobile=null,this.nickname=null,this.gender=null,this.email=null},init:function(){n.isGuest||this.reload()}};return i.init(),i}]).factory("CartService",["$http","$q",function(t,e){var n={all:[],add:function(i,a){return e(function(e,r){t.post("api/v1/cart/add",{goodsId:a}).then(function(t){"success"===t.data.status?(n.refresh(i),e(t)):r(t)},function(t){r(t)})})},subtract:function(i,a){return e(function(e,r){t.post("api/v1/cart/subtract",{goodsId:a}).then(function(t){"success"===t.data.status?(n.refresh(i),e(t)):r(t)},function(t){r(t)})})},clear:function(i){return e(function(e,a){t.put("api/v1/cart/clear",{storeId:i}).then(function(t){if("success"===t.data.status){var r=n.get(i);r.goodsList=[],r.length=0,r.volume="0.00",e(t)}else a(t)},function(t){a(t)})})},"delete":function(i,a){return e(function(e,r){t["delete"]("api/v1/cart/delete",{params:{id:a}}).then(function(t){"success"===t.data.status?(n.refresh(i),e(t)):r(t)},function(t){r(t)})})},refresh:function(i){return e(function(e,a){t.get("api/v1/cart/index",{params:{id:i}}).then(function(t){var a=n.get(i);a.goodsList=t.data.goodsList,a.length=t.data.length,a.volume=t.data.volume,e(t)},function(t){a(t)})})},get:function(t){return this.all[t]||(this.all[t]={goodsList:[],length:0,volume:"0.00"}),this.all[t]},destroyAll:function(){this.all.length=0}};return n}]).factory("SchoolService",["$http",function(t){var e={all:[],lastSchoolId:null,setLastSchoolId:function(t){this.lastSchoolId=t,window.localStorage.setItem("lastSchoolId",t)},getSchoolName:function(t){return this.all[t]},init:function(){t.get("api/v1/school/all").then(function(t){e.all=t.data});var n=window.localStorage.getItem("lastSchoolId");n&&(this.lastSchoolId=n)}};return e.init(),e}]).factory("OrderService",["$http","$q","UserService",function(t,e,n){var i={_links:[],_meta:[],items:[],isEnd:!0,statusList:{unshipped:"未发货",shipped:"配送中",unpaid:"待付款",completed:"订单完成",cancelled:"订单取消"},getStatusMsg:function(t){return this.statusList[t]},getOne:function(t){for(var e in this.items)if(this.items[e].id==t)return this.items[e];return null},receive:function(n){return e(function(e,a){t.put("api/v1/order/receive",{},{params:{id:n}}).then(function(t){if("success"===t.data.status){var r=i.getOne(n);r&&(r.status=t.data.data.status),e(t)}else a(t)},function(t){a(t)})})},cancel:function(n){return e(function(e,a){t.put("api/v1/order/cancel",{},{params:{id:n}}).then(function(t){if("success"===t.data.status){var r=i.getOne(n);r&&(r.status=t.data.data.status),e(t)}else a(t)},function(t){a(t)})})},timeout:function(n){return e(function(e,a){t.put("api/v1/order/timeout",{},{params:{id:n}}).then(function(t){if("success"===t.data.status){var r=i.getOne(n);r&&(r.status=t.data.data.status),e(t)}else a(t)},function(t){a(t)})})},reload:function(){return e(function(e,n){t.get("api/v1/order/index").then(function(t){i._links=t.data._links,i._meta=t.data._meta,i.items=t.data.items,i.isEnd=i._meta.currentPage>=i._meta.pageCount,e(t)},function(t){n(t)})})},loadNext:function(){return e(function(e,n){i.isEnd?n("pageEnd"):t.get(i._links.next.href).then(function(t){i._links=t.data._links,i._meta=t.data._meta,i.items=i.items.concat(t.data.items),i.isEnd=i._meta.currentPage==i._meta.pageCount,e(t)},function(t){n(t)})})},destroy:function(){this._links.length=0,this._meta.length=0,this.items.length=0},init:function(){n.isGuest||this.reload()}};return i.init(),i}]).factory("AddressService",["$http","$q","UserService",function(t,e,n){var i={all:[],genderList:{male:"帅哥",woman:"美女"},getGenderMsg:function(t){return this.genderList[t]},getBySchoolId:function(t){var e=[];for(var n in this.all)this.all[n].school_id==t&&("1"===this.all[n].is_default?e.unshift(this.all[n]):e.push(this.all[n]));return e},getOne:function(t){for(var e in this.all)if(this.all[e].id==t)return this.all[e];return null},reload:function(){return e(function(e,n){t.get("api/v1/address/all").then(function(t){i.all=t.data,e(t)},function(t){n(t)})})},destroy:function(){this.all.length=0},init:function(){n.isGuest||this.reload()}};return i.init(),i}]);